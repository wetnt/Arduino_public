#include "G5_Drive.h"

#define LENG 40
byte pBuf[LENG];

G5ST_type g;

unsigned int G5Val(int a, int b) {
  unsigned int v = pBuf[a] << 8;
  if (b > 0) v += pBuf[b];
  return v;
}
void G5Exp() {
  //------------------------------------------------
  g.len = G5Val(0, 1);     //[0][1]=2*13+2 帧长度
  //------------------------------------------------
  //标准颗粒物浓度（CF=1）
  g.cf10 = G5Val(2, 3);    //[2][3]=PM1.0=ug/m3
  g.cf25 = G5Val(4, 5);    //[4][5]=PM2.5=ug/m3
  g.cf1X = G5Val(6, 7);    //[6][7]=PM10 =ug/m3
  //------------------------------------------------
  //大气环境下
  g.pm10 = G5Val(8, 9);     //[8][9]  =PM1.0=ug/m3
  g.pm25 = G5Val(10, 11);   //[10][11]=PM2.5=ug/m3
  g.pm1X = G5Val(12, 13);   //[12][13]=PM10 =ug/m3
  //------------------------------------------------
  //0.1升空气中xxum直径颗粒物个数
  g.um03 = G5Val(14, 15);   //[14][15]=0.3um
  g.um05 = G5Val(16, 17);   //[16][17]=0.5um
  g.um10 = G5Val(18, 19);   //[18][19]=1.0um
  g.um25 = G5Val(20, 21);   //[20][21]=2.5um
  g.um50 = G5Val(22, 23);   //[22][23]=5.0um
  g.um1X = G5Val(24, 25);   //[24][25]=10.0um
  //------------------------------------------------
  g.hcho = G5Val(26, 27);   //[26][27]=x/1000mg/m3
  g.tmps = G5Val(28, 29);   //[28][29]=x/10℃
  g.hums = G5Val(30, 31);   //[30][31]=x/10%
  //------------------------------------------------  
  g.empt = G5Val(32, 33);   //[32][33]保留
  //------------------------------------------------
  g.vers = G5Val(34, -1);   //[34]版本号
  g.errs = G5Val(35, -1);   //[35]错误号
  g.chek = G5Val(36, 37);   //[36][37]校验和
  //------------------------------------------------
  //G5_Show();
  //------------------------------------------------
}
void G5Feed(byte c) {
  //------------------------------------------------
  static int state = 0;
  static int count = 0;
  //------------------------------------------------
  if (0x42 == c) state = 1;
  if (0x4d == c && state == 1) {
    state = 2;
    count = -1;
  }
  //------------------------------------------------
  pBuf[count++] = c;//lg(c);
  //------------------------------------------------
  if (count == 30) G5Exp();
  //------------------------------------------------
}




